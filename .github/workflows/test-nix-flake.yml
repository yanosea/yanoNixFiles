name: Test Nix Flake
on:
  pull_request:
    branches:
      - main
  repository_dispatch:
    types: [test-flake]
  workflow_dispatch:
permissions:
  contents: read
  statuses: write
  pull-requests: read
jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.branch || github.ref }}
      - name: install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - name: check flake syntax
        run: nix flake check
      - name: check formatting
        run: |
          # run formatter and check if any files changed
          nix fmt
          if ! git diff --exit-code; then
            echo "Files are not properly formatted. Please run 'nix fmt' locally and commit the changes."
            exit 1
          fi
  test-nixos-builds:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        configuration:
          - yanoNixOs
          - yanoNixOsWsl
    steps:
      - name: checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.branch || github.ref }}
      - name: install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - name: check NixOS configuration - ${{ matrix.configuration }}
        run: |
          # validate configuration syntax and dependencies
          nix eval .#nixosConfigurations.${{ matrix.configuration }}.config.system.build.toplevel.drvPath \
            --show-trace
      - name: build NixOS configuration (dry-run) - ${{ matrix.configuration }}
        run: |
          # check build dependencies without actual building
          nix build .#nixosConfigurations.${{ matrix.configuration }}.config.system.build.toplevel \
            --dry-run \
            --show-trace
  test-darwin-builds:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        configuration:
          - yanoMac
          - yanoMacBook
    steps:
      - name: checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.branch || github.ref }}
      - name: install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - name: check Darwin configuration - ${{ matrix.configuration }}
        run: |
          # validate configuration syntax and dependencies
          nix eval .#darwinConfigurations.${{ matrix.configuration }}.system.drvPath \
            --show-trace
      - name: build Darwin configuration (dry-run) - ${{ matrix.configuration }}
        run: |
          # check build dependencies without actual building
          nix build .#darwinConfigurations.${{ matrix.configuration }}.system \
            --dry-run \
            --show-trace
  test-home-manager-builds:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        configuration:
          - "yanosea@yanoNixOs"
          - "yanosea@yanoNixOsWsl"
    steps:
      - name: checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.branch || github.ref }}
      - name: install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - name: check Home Manager configuration - ${{ matrix.configuration }}
        run: |
          # validate configuration syntax and dependencies
          nix eval .#homeConfigurations.\"${{ matrix.configuration }}\".activationPackage.drvPath \
            --show-trace
      - name: build Home Manager configuration (dry-run) - ${{ matrix.configuration }}
        run: |
          # check build dependencies without actual building
          nix build .#homeConfigurations.\"${{ matrix.configuration }}\".activationPackage \
            --dry-run \
            --show-trace
  test-home-manager-darwin-builds:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        configuration:
          - "yanosea@yanoMac"
          - "yanosea@yanoMacBook"
    steps:
      - name: checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.client_payload.branch || github.ref }}
      - name: install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - name: check Home Manager configuration - ${{ matrix.configuration }}
        run: |
          # validate configuration syntax and dependencies
          nix eval .#homeConfigurations.\"${{ matrix.configuration }}\".activationPackage.drvPath \
            --show-trace
      - name: build Home Manager configuration (dry-run) - ${{ matrix.configuration }}
        run: |
          # check build dependencies without actual building
          nix build .#homeConfigurations.\"${{ matrix.configuration }}\".activationPackage \
            --dry-run \
            --show-trace
  report-status:
    runs-on: ubuntu-latest
    needs:
      - lint-and-format
      - test-nixos-builds
      - test-darwin-builds
      - test-home-manager-builds
      - test-home-manager-darwin-builds
    if: always() && github.event_name == 'repository_dispatch'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: determine overall status
        id: status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Some tests failed" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "state=error" >> $GITHUB_OUTPUT
            echo "description=Tests were cancelled" >> $GITHUB_OUTPUT
          else
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=All tests passed" >> $GITHUB_OUTPUT
          fi
      - name: get PR head SHA
        id: pr
        run: |
          SHA=$(gh api /repos/${{ github.repository }}/pulls/${{ github.event.client_payload.pr_number }} --jq '.head.sha')
          echo "sha=$SHA" >> $GITHUB_OUTPUT
      - name: report commit status
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/statuses/${{ steps.pr.outputs.sha }} \
            -f state='${{ steps.status.outputs.state }}' \
            -f target_url='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}' \
            -f description='${{ steps.status.outputs.description }}' \
            -f context='Test Nix Flake'
